<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Linker - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1419;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #fff;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .connection-status {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status.connected {
            background: #1a3a1a;
            color: #4caf50;
            border: 1px solid #2d5a2d;
        }

        .connection-status.disconnected {
            background: #3a1a1a;
            color: #f44336;
            border: 1px solid #5a2d2d;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .connected .status-indicator {
            background: #4caf50;
        }

        .disconnected .status-indicator {
            background: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #1a1f2e;
            border: 1px solid #2a3142;
            border-radius: 8px;
            padding: 20px;
        }

        .card h2 {
            font-size: 16px;
            color: #9ca3af;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat {
            font-size: 36px;
            color: #fff;
            font-weight: 600;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }

        .instance-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .instance {
            background: #252b3b;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }

        .instance-name {
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .instance-desc {
            font-size: 13px;
            color: #9ca3af;
        }

        .instance-time {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }

        .message-log {
            background: #1a1f2e;
            border: 1px solid #2a3142;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message-log h2 {
            font-size: 16px;
            color: #9ca3af;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-entry {
            padding: 10px;
            margin-bottom: 8px;
            background: #252b3b;
            border-radius: 4px;
            border-left: 3px solid #10b981;
            font-size: 13px;
        }

        .message-entry.delivered {
            border-left-color: #3b82f6;
        }

        .message-entry.read {
            border-left-color: #8b5cf6;
        }

        .message-time {
            color: #6b7280;
            font-size: 11px;
        }

        .message-from {
            color: #3b82f6;
            font-weight: 600;
        }

        .message-to {
            color: #10b981;
            font-weight: 600;
        }

        .priority-high {
            color: #ef4444;
        }

        .priority-normal {
            color: #6b7280;
        }

        .priority-low {
            color: #94a3b8;
        }

        .empty-state {
            text-align: center;
            color: #6b7280;
            padding: 40px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-box {
            text-align: center;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1f2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #3b4252;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4c566a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Claude Code Linker Dashboard</h1>

        <div id="connectionStatus" class="connection-status disconnected">
            <div class="status-indicator"></div>
            <span>Disconnected from broker</span>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìä Message Stats</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat" id="totalMessages">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat" id="deliveredMessages">0</div>
                        <div class="stat-label">Delivered</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat" id="readMessages">0</div>
                        <div class="stat-label">Read</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>‚ö° Priority Queue</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat priority-high" id="highPriority">0</div>
                        <div class="stat-label">High</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat priority-normal" id="normalPriority">0</div>
                        <div class="stat-label">Normal</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat priority-low" id="lowPriority">0</div>
                        <div class="stat-label">Low</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>‚è±Ô∏è Performance</h2>
                <div class="stat-box">
                    <div class="stat" id="avgDeliveryTime">0ms</div>
                    <div class="stat-label">Avg Delivery Time</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üë• Connected Instances (<span id="instanceCount">0</span>)</h2>
                <div id="instanceList" class="instance-list">
                    <div class="empty-state">No instances connected</div>
                </div>
            </div>

            <div class="message-log">
                <h2>üì® Recent Activity</h2>
                <div id="messageLog">
                    <div class="empty-state">No messages yet</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BROKER_URL = 'ws://localhost:8765';
        let ws = null;
        let dashboardId = null;
        const messageLog = [];
        const MAX_LOG_SIZE = 100;

        function connect() {
            ws = new WebSocket(BROKER_URL);

            ws.onopen = () => {
                console.log('Connected to broker');
                updateConnectionStatus(true);
                requestStats();
                // Request stats every 5 seconds
                setInterval(requestStats, 5000);
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };

            ws.onclose = () => {
                console.log('Disconnected from broker');
                updateConnectionStatus(false);
                setTimeout(connect, 5000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function handleMessage(message) {
            switch (message.type) {
                case 'connected':
                    // Register as dashboard
                    ws.send(JSON.stringify({
                        type: 'register',
                        payload: {
                            name: 'dashboard-' + Date.now(),
                            description: 'Web Dashboard',
                            metadata: { type: 'dashboard' }
                        }
                    }));
                    break;

                case 'registered':
                    dashboardId = message.instanceId;
                    break;

                case 'stats':
                    updateStats(message.stats);
                    break;

                case 'instances':
                    updateInstances(message.instances);
                    break;

                case 'new_message':
                    logMessage('sent', message.message);
                    break;

                case 'delivery_receipt':
                    logMessage('delivered', message.receipt);
                    break;

                case 'read_receipt':
                    logMessage('read', message.receipt);
                    break;
            }
        }

        function requestStats() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'get_stats' }));
                ws.send(JSON.stringify({ type: 'list_instances' }));
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            statusEl.innerHTML = `
                <div class="status-indicator"></div>
                <span>${connected ? 'Connected to broker' : 'Disconnected from broker'}</span>
            `;
        }

        function updateStats(stats) {
            document.getElementById('totalMessages').textContent = stats.total || 0;
            document.getElementById('deliveredMessages').textContent = stats.byStatus.delivered || 0;
            document.getElementById('readMessages').textContent = stats.byStatus.read || 0;
            document.getElementById('highPriority').textContent = stats.byPriority.high || 0;
            document.getElementById('normalPriority').textContent = stats.byPriority.normal || 0;
            document.getElementById('lowPriority').textContent = stats.byPriority.low || 0;
            document.getElementById('avgDeliveryTime').textContent = `${stats.avgDeliveryTime}ms`;
        }

        function updateInstances(instances) {
            const listEl = document.getElementById('instanceList');
            const countEl = document.getElementById('instanceCount');

            // Filter out dashboard instances
            const realInstances = instances.filter(inst => !inst.name.startsWith('dashboard-'));
            countEl.textContent = realInstances.length;

            if (realInstances.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No instances connected</div>';
                return;
            }

            listEl.innerHTML = realInstances.map(inst => `
                <div class="instance">
                    <div class="instance-name">${escapeHtml(inst.name)}</div>
                    <div class="instance-desc">${escapeHtml(inst.description)}</div>
                    <div class="instance-time">Last seen: ${formatTime(inst.lastSeen)}</div>
                </div>
            `).join('');
        }

        function logMessage(type, data) {
            const entry = {
                type,
                data,
                timestamp: new Date()
            };

            messageLog.unshift(entry);
            if (messageLog.length > MAX_LOG_SIZE) {
                messageLog.pop();
            }

            renderMessageLog();
        }

        function renderMessageLog() {
            const logEl = document.getElementById('messageLog');

            if (messageLog.length === 0) {
                logEl.innerHTML = '<div class="empty-state">No messages yet</div>';
                return;
            }

            logEl.innerHTML = messageLog.map(entry => {
                const time = entry.timestamp.toLocaleTimeString();

                if (entry.type === 'sent') {
                    const msg = entry.data;
                    return `
                        <div class="message-entry">
                            <div class="message-time">${time}</div>
                            <div>
                                <span class="message-from">${escapeHtml(msg.fromName)}</span> ‚Üí
                                <span class="message-to">${msg.broadcast ? 'all' : escapeHtml(msg.to)}</span>
                                ${msg.priority && msg.priority !== 'normal' ? `<span class="priority-${msg.priority}">[${msg.priority}]</span>` : ''}
                            </div>
                            <div>${escapeHtml(msg.content.substring(0, 100))}${msg.content.length > 100 ? '...' : ''}</div>
                        </div>
                    `;
                } else if (entry.type === 'delivered') {
                    const receipt = entry.data;
                    return `
                        <div class="message-entry delivered">
                            <div class="message-time">${time}</div>
                            <div>‚úì Message delivered to <span class="message-to">${escapeHtml(receipt.to)}</span></div>
                        </div>
                    `;
                } else if (entry.type === 'read') {
                    const receipt = entry.data;
                    return `
                        <div class="message-entry read">
                            <div class="message-time">${time}</div>
                            <div>‚úì‚úì Message read by <span class="message-to">${escapeHtml(receipt.to)}</span></div>
                        </div>
                    `;
                }
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return date.toLocaleDateString();
        }

        // Start connection
        connect();
    </script>
</body>
</html>
